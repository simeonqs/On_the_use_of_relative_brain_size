---
title: "On the use of relative brain size - supplemental materials"
author: "Simeon Q. Smeele $^{1,2,3}$"
date: "April 2022"
output:
  pdf_document: default
header-includes:
- \usepackage{lineno}
- \linenumbers
editor_options:
  chunk_output_type: console
bibliography: bibliography.bib
---

```{r set-up, include=FALSE}
# Libraries
## for installation instructions see the README
library(cmdstanr)
library(scales)

# Paths
path_response_stan = 'models/response.stan' # models
path_predictor_stan = 'models/predictor.stan'
path_sem_stan = 'models/sem.stan'
path_supplemental_models = 'supplemental models' # folder to supplemental models
path_supplemental_figures = 'supplemental figures' # folder to plot supplemental figures
path_pdf_response_20 = 'supplemental figures/response 20.pdf' # pdfs
path_pdf_response_1000 = 'supplemental figures/response 1000.pdf'
path_pdf_predictor_20 = 'supplemental figures/predictor 20.pdf'
path_pdf_predictor_1000 = 'supplemental figures/predictor 1000.pdf'
path_pdf_response_informative = 'supplemental figures/response informative.pdf'
path_pdf_response_vague = 'supplemental figures/response vague.pdf'
path_pdf_predictor_informative = 'supplemental figures/predictor informative.pdf'
path_pdf_predictor_vague = 'supplemental figures/predictor vague.pdf'
```

$^1$Cognitive & Cultural Ecology Research Group, Max Planck Institute of Animal Behavior, Radolfzell, Germany

$^2$Department of Human Behavior, Ecology and Culture, Max Planck Institute for Evolutionary
Anthropology, Leipzig, Germany

$^3$Department of Biology, University of Konstanz, Konstanz, Germany

# Methods

## Sample size

The main text contained results for data sets with 100 species. To see how the models perform with a smaller or larger dataset, I simulated data for 20 and 1000 species, with 20 simulations per case and sample size. 

## Priors

The main text contained results for Bayesian models with slightly regularising priors. In emperical data sets, one can often choose more informative priors. To test the effect of this I analysed the dataset with 100 species with priors that only allow for positive slopes, with the mean set to the simulated value (1). I also restricted the priors for the intecept parameters to normal(0, 0.25).

To further test the robustness of the models I analysed the data with vague priors, settings intercept and slope to normal(0, 10) and standard variation parameters to exponential(0.1) (note that the mean for the exponential distribution is the inverse of the rate, such that the mean standard deviation here is 10).

# Results

## Sample size

### Case I: relative brain size as response variable

```{r response-sampsize, include=FALSE}
for(N in c(20, 1000)){
  # Settings
  set.seed(1)
  z_effect = 1
  body_effect = 1
  model_response = cmdstan_model(path_response_stan)
  if(N == 20) ylim = c(0, 5) else ylim = c(0, 15)
  
  # Simulate data 20 times
  out = lapply(1:20, function(i){
    body_size = rnorm(N, 1, 1)
    z = rnorm(N, 0, 1)
    mu_brain = body_effect * body_size + z_effect * z
    brain_size = rnorm(N, mu_brain, 1)
    
    # Run linear model
    linear_fit = lm(brain_size ~ body_size + z)
    
    # Run Bayesian linear model
    d = list(N = N, brain_size = brain_size, body_size = body_size, z = z) # save data as list
    bay_linear_fit = model_response$sample(data = d, # run model
                                           seed = 1, 
                                           chains = 4, 
                                           parallel_chains = 4, # runs on four threads
                                           refresh = 2000)
    post_linear_fit = bay_linear_fit$draws(format = 'draws_df') # draw posterior samples
    
    return(list(linear_fit = linear_fit, post_linear_fit = post_linear_fit))
  })
  
  # Plot the fit
  pdf(sprintf('%s/response %s.pdf', path_supplemental_figures, N), 6, 5)
  par(mfrow = c(2,2), oma = c(1, 4, 1, 1), mar = c(4, 1, 2, 3))
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, xlab = '', yaxt = 'n', main = 'linear model')
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect z', 1, 2.5)
  abline(v = z_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[3],
                                     summary(out[[i]]$linear_fit)$coefficients[3,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  mtext('z', 2, 3, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian linear model')
  abline(v = z_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_z), pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect z', 1, 2.5)
  
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[2], 
                                     summary(out[[i]]$linear_fit)$coefficients[2,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  mtext('body', 2, 3, font = 2, las = 2, adj = 0)
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_body), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  dev.off()
}
```

```{r plot response-20, echo=FALSE, out.width = "50%", fig.cap= "Model with sample size 20. Parameter estimates from the linear model and Bayesian linear model with brain size as response variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_response_20)
```

```{r plot response-1000, echo=FALSE, out.width = "50%", fig.cap= "Model with sample size 1000. Parameter estimates from the linear model and Bayesian linear model with brain size as response variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_response_1000)
```

### Case II: relative brain size as predictor variable

```{r predictor-sampsize, include=FALSE}
for(N in c(20, 1000)){
  
  # Settings
  set.seed(1)
  brain_effect = 1
  body_effect = 1
  model_predictor = cmdstan_model(path_predictor_stan)
  model_sem = cmdstan_model(path_sem_stan)
  if(N == 20) ylim = c(0, 5) else ylim = c(0, 15)
  
  # Simulate data
  out = lapply(1:20, function(i){
    body_size = rnorm(N, 0, 1)
    rel_brain_size = rnorm(N, 0, 1)
    brain_size = 1 * body_size + rel_brain_size
    mu_z = body_effect * body_size + brain_effect * rel_brain_size
    z = rnorm(N, mu_z, 1)
    
    # Run linear model
    linear_fit = lm(z ~ body_size + brain_size)
    
    # Run Bayesian linear model
    d = list(N = N, brain_size = brain_size, body_size = body_size, z = z)
    bay_linear_fit = model_predictor$sample(data = d, 
                                            seed = 1, 
                                            chains = 4, 
                                            parallel_chains = 4,
                                            refresh = 2000)
    post_linear_fit = bay_linear_fit$draws(format = 'draws_df')
    
    # Run Bayesian SEM
    bay_sem_fit = model_sem$sample(data = d, 
                                   seed = 1, 
                                   chains = 4, 
                                   parallel_chains = 4,
                                   refresh = 2000)
    post_sem_fit = bay_sem_fit$draws(format = 'draws_df')
    
    return(list(linear_fit = linear_fit, post_linear_fit = post_linear_fit, post_sem_fit = post_sem_fit))
  })
  
  # Plot the fit
  pdf(sprintf('%s/predictor %s.pdf', path_supplemental_figures, N), 9, 5)
  par(mfrow = c(2,3), oma = c(1, 4, 1, 1), mar = c(4, 1, 2, 3))
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'linear model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[3],
                                     summary(out[[i]]$linear_fit)$coefficients[3,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  mtext('brain', 2, 4, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian linear model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_brain), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian SEM model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_sem_fit$b_brain_z), 
                       pch = 16, cex = 3, col = alpha('#16A085', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[2],
                                     summary(out[[i]]$linear_fit)$coefficients[2,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  mtext('body', 2, 4, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_body), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_sem_fit$b_body_z), 
                       pch = 16, cex = 3, col = alpha('#16A085', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  dev.off()
  
}
```

```{r plot predictor-20, echo=FALSE, out.width = "72%", fig.cap= "Model with sample size 20. Parameter estimates from the linear model, Bayesian linear model and Bayesian strucutral equation model (SEM) with relative brain size as predictor variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_predictor_20)
```

```{r plot predictor-1000, echo=FALSE, out.width = "72%", fig.cap= "Model with sample size 1000. Parameter estimates from the linear model, Bayesian linear model and Bayesian strucutral equation model (SEM) with relative brain size as predictor variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_predictor_1000)
```

## Priors

### Case I: relative brain size as response variable

```{r response-prior, include=FALSE}
for(prior_type in c('informative', 'vague')){
  
  # Settings
  set.seed(1)
  N = 20
  z_effect = 1
  body_effect = 1
  model_response = cmdstan_model(sprintf('%s/response_%s.stan', path_supplemental_models, prior_type))
  ylim = c(0, 5)
  
  # Simulate data 20 times
  out = lapply(1:20, function(i){
    body_size = rnorm(N, 1, 1)
    z = rnorm(N, 0, 1)
    mu_brain = body_effect * body_size + z_effect * z
    brain_size = rnorm(N, mu_brain, 1)
    
    # Run linear model
    linear_fit = lm(brain_size ~ body_size + z)
    
    # Run Bayesian linear model
    d = list(N = N, brain_size = brain_size, body_size = body_size, z = z) # save data as list
    bay_linear_fit = model_response$sample(data = d, # run model
                                           seed = 1, 
                                           chains = 4, 
                                           parallel_chains = 4, # runs on four threads
                                           refresh = 2000)
    post_linear_fit = bay_linear_fit$draws(format = 'draws_df') # draw posterior samples
    
    return(list(linear_fit = linear_fit, post_linear_fit = post_linear_fit))
  })
  
  # Plot the fit
  pdf(sprintf('%s/response %s.pdf', path_supplemental_figures, prior_type), 6, 5)
  par(mfrow = c(2,2), oma = c(1, 4, 1, 1), mar = c(4, 1, 2, 3))
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, xlab = '', yaxt = 'n', main = 'linear model')
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect z', 1, 2.5)
  abline(v = z_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[3],
                                     summary(out[[i]]$linear_fit)$coefficients[3,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  mtext('z', 2, 3, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian linear model')
  abline(v = z_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_z), pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect z', 1, 2.5)
  
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[2], 
                                     summary(out[[i]]$linear_fit)$coefficients[2,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  mtext('body', 2, 3, font = 2, las = 2, adj = 0)
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_body), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  dev.off()
}
```

```{r plot response-informative, echo=FALSE, out.width = "50%", fig.cap= "Model with informative priors. Parameter estimates from the linear model and Bayesian linear model with brain size as response variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_response_informative)
```

```{r plot response-vague, echo=FALSE, out.width = "50%", fig.cap= "Model with vague priors. Parameter estimates from the linear model and Bayesian linear model with brain size as response variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_response_vague)
```

### Case II: relative brain size as predictor variable

```{r predictor-prior, include=FALSE}
for(prior_type in c('informative', 'vague')){
  
  # Settings
  set.seed(1)
  N = 100
  brain_effect = 1
  body_effect = 1
  model_predictor = cmdstan_model(sprintf('%s/predictor_%s.stan', path_supplemental_models, prior_type))
  model_sem = cmdstan_model(sprintf('%s/sem_%s.stan', path_supplemental_models, prior_type))
  ylim = c(0, 5)
  
  # Simulate data
  out = lapply(1:20, function(i){
    body_size = rnorm(N, 0, 1)
    rel_brain_size = rnorm(N, 0, 1)
    brain_size = 1 * body_size + rel_brain_size
    mu_z = body_effect * body_size + brain_effect * rel_brain_size
    z = rnorm(N, mu_z, 1)
    
    # Run linear model
    linear_fit = lm(z ~ body_size + brain_size)
    
    # Run Bayesian linear model
    d = list(N = N, brain_size = brain_size, body_size = body_size, z = z)
    bay_linear_fit = model_predictor$sample(data = d, 
                                            seed = 1, 
                                            chains = 4, 
                                            parallel_chains = 4,
                                            refresh = 2000)
    post_linear_fit = bay_linear_fit$draws(format = 'draws_df')
    
    # Run Bayesian SEM
    bay_sem_fit = model_sem$sample(data = d, 
                                   seed = 1, 
                                   chains = 4, 
                                   parallel_chains = 4,
                                   refresh = 2000)
    post_sem_fit = bay_sem_fit$draws(format = 'draws_df')
    
    return(list(linear_fit = linear_fit, post_linear_fit = post_linear_fit, post_sem_fit = post_sem_fit))
  })
  
  # Plot the fit
  pdf(sprintf('%s/predictor %s.pdf', path_supplemental_figures, prior_type), 9, 5)
  par(mfrow = c(2,3), oma = c(1, 4, 1, 1), mar = c(4, 1, 2, 3))
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'linear model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[3],
                                     summary(out[[i]]$linear_fit)$coefficients[3,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  mtext('brain', 2, 4, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian linear model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_brain), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = 'Bayesian SEM model')
  abline(v = brain_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_sem_fit$b_brain_z), 
                       pch = 16, cex = 3, col = alpha('#16A085', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect brain size', 1, 2.5)
  
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(rnorm(1e5, out[[i]]$linear_fit$coefficients[2],
                                     summary(out[[i]]$linear_fit)$coefficients[2,2])), 
                       pch = 16, cex = 3, col = alpha('#D68910', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  mtext('body', 2, 4, font = 2, las = 2, adj = 0)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_linear_fit$b_body), 
                       pch = 16, cex = 3, col = alpha('#7D3C98', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  plot(NULL, xlim = c(-0.5, 1.5), ylim = ylim, 
       xlab = '', yaxt = 'n', main = '')
  abline(v = body_effect, lty = 2, lwd = 5, col = alpha('black', 0.5))
  for(i in 1:20) lines(density(out[[i]]$post_sem_fit$b_body_z), 
                       pch = 16, cex = 3, col = alpha('#16A085', 0.5))
  axis(4)
  mtext('density', 4, 2.5)
  mtext('effect body size', 1, 2.5)
  dev.off()
  
}
```

```{r plot predictor-informative, echo=FALSE, out.width = "72%", fig.cap= "Model with informative priors. Parameter estimates from the linear model, Bayesian linear model and Bayesian strucutral equation model (SEM) with relative brain size as predictor variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_predictor_informative)
```

```{r plot predictor-vague, echo=FALSE, out.width = "72%", fig.cap= "Model with vague priors. Parameter estimates from the linear model, Bayesian linear model and Bayesian strucutral equation model (SEM) with relative brain size as predictor variable. Dashed grey line is the true value. Orange density plots are normal distributions based on the mean and SE from the linear model. Purple and green density plots are the posterior distributions from the Bayesian models."}
knitr::include_graphics(path_pdf_predictor_vague)
```


